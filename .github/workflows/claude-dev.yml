name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          separator: ","
          
      - name: Claude Code Review
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const { Anthropic } = require('@anthropic-ai/sdk');
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });
            
            // Get PR details
            const pr = context.payload.pull_request;
            const files = '${{ steps.changed-files.outputs.all_changed_files }}'.split(',');
            
            // Get diff for changed files
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              mediaType: {
                format: 'diff'
              }
            });
            
            // Ask Claude to review
            const prompt = `Review this pull request for a Porsche market analytics website:
            
            PR Title: ${pr.title}
            PR Description: ${pr.body || 'No description provided'}
            
            Changed files: ${files.join(', ')}
            
            Diff:
            ${diff}
            
            Please provide:
            1. Summary of changes
            2. Potential issues or bugs
            3. Security concerns
            4. Performance implications
            5. Suggestions for improvement
            
            Focus on TypeScript/React best practices and data accuracy for Porsche models.`;
            
            const message = await anthropic.messages.create({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 2000,
              messages: [{ role: 'user', content: prompt }],
            });
            
            // Post review comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## ðŸ¤– Claude Code Review\n\n${message.content[0].text}`
            });